################################################################################
#
#  g54-coordinate-offsets.json - test G53 - G59 coordinate system functions
#
# Do not run any preamble before this file
#
# This file sets up the board to behave as an Othermachine Othermill:
#   X min/max travel                0, 145.6
#   Y min/max travel                0, 119.1
#   Z min/max travel                -60.1, 0
#
#   XYZ maximum velocity            1500 mm/min
#   XYZ maximum jerk                 500 mm/min^3 (* 1,000,000)
#   JT junction integration time    0.75
#
#   Other parameters such as limit enables, motor power, etc. are not changed
#   Motor mapping is assumed to be correct and not messed with.
#
#   Position the head at machine origin or some other unobstructed start position
*   Ensure that clearance from start position is at least (60,60,-30)
#   The origin position will be set to (0,0,0) by the G28.3 command
#
# SETUP ROUTINES
#
{
    "defaults": {
        "fail":"hard"
    }
}
#
{
    "t":{"label":"Restore default settings",
        "before":["{defa:1}"],
        "send":["G21"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set baseline configs",
        "send":["{jv:5}", "{tv:1}", "{qv:0}", "{sv:2}", "{si:200}"],
        "delay":0.100},
    "r":{"status":0}
}
# SKIP - not yet implemented
{
    "t":{"label":"Clear status report - THIS FUNCTION SHOULD ALWAYS RUN BY ITSELF",
        "send":["{srs:{clear:t}}"]},
    "r":{"status":0}
}
# SKIP - not yet implemented
{
    "t":{"label":"Set status report - RUNS AFTER CLEAR STATUS REPORT",
        "send":["{srs:{set:{line:t,posx:t,posy:t,posz:t,posa:t,feed:t,vel:t,unit:t,coor:t,dist:t,stat:t}}}"]},
    "r":{"status":0}
}
# Use old-style status report setup line
{
    "t":{"label":"Set status report - RUNS AFTER CLEAR STATUS REPORT",
        "send":["{sr:{line:t,posx:t,posy:t,posz:t,posa:t,feed:t,vel:t,unit:t,coor:t,dist:t,stat:t}}"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set gcode defaults - clear coordinate offsets",
        "send":["G21 G94 G90 G91.1",
                "G10 L2 P1 X0 Y0 Z0",
                "G10 L2 P2 X0 Y0 Z0",
                "G10 L2 P3 X0 Y0 Z0",
                "G10 L2 P4 X0 Y0 Z0",
                "G10 L2 P5 X0 Y0 Z0",
                "G10 L2 P6 X0 Y0 Z0",
                "G54"
               ]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set current point as machine origin (0,0,0)",
        "send":["g28.3 x0 y0 z0"]},
    "r":{"status":0}
}
#
# TESTS
#
# Basic offset tests
#
{
    "t":{"label":"Move to test position in G54 coordinates",
        "send":["g0 x40 y40 z-20"]},
    "r":{"status":0},
    "sr":{"posx": 40, "posy": 40, "posz": -20}
}
#
{
    "t":{"label":"Return to origin in G54",
        "send":["g0 x0 y0 z0"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}
#
{
    "t":{"label":"return to test position in G54",
        "send":["g0 x40 y40 z-20"]},
    "r":{"status":0},
    "sr":{"posx": 40, "posy": 40, "posz": -20}
}
# G10 L20 G55
{
    "t":{"label":"Set test position as (0,0,0) in G55",
        "send":["G10 L20 P2 X0 Y0 Z0"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Return to origin in G54",
        "send":["g0 x0 y0 z0"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}
#
{
    "t":{"label":"Change to G55 and report position",
        "send":["G55"]},
    "r":{"status":0},
    "sr":{"posx": -40, "posy": -40, "posz": 20}
}
#
{
    "t":{"label":"Return to test position in G55",
        "before":["G55"],
        "send":["g0 x0 y0 z0"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}
# G10 L2 G59
{
    "t":{"label":"Set test position as (20,20,-10) in G59",
        "send":["G10 L2 P6 X20 Y20 Z-10"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Change to G59 and report position",
        "send":["G59"]},
    "r":{"status":0},
    "sr":{"posx": 20, "posy": 20, "posz": -10}
}
#
{
    "t":{"label":"Return to origin in G59",
        "before":["G59"],
        "send":["g0 x-20 y-20 z10"]},
    "r":{"status":0},
    "sr":{"posx": -20, "posy": -20, "posz": 10}
}

# EOF



#
# G28 / G54 TEST
{
    "t":{"label":"Move to starting position in G54 coordinates",
        "before":["G21"],
        "send":["g0 x50 y50 z-30"]},
    "r":{"status":0},
    "sr":{"posx": 50, "posy": 50, "posz": -30}
}
#
{
    "t":{"label":"Save G28 starting position",
        "send":["G28.1"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Move to new position",
        "send":["g0 x60 y60 z-20"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Return to G28 starting position",
        "send":["G28"]},
    "r":{"status":0},
    "sr":{"posx": 50, "posy": 50, "posz": -30}
}
#
{
    "t":{"label":"Move to new position",
        "send":["g0 x60 y60 z-20"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Return to G28 starting position through Z-30",
        "send":["G28 X50 Y50"]},
    "r":{"status":0},
    "sr":{"posx": 50, "posy": 50, "posz": -30}
}
#
# G28 / G55 TEST SETUP
#
{
    "t":{"label":"Save current position as G28 starting position in G54",
        "send":["G54","G28.1"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set G55 coordinates (1,1,1)",
        "send":["G10 L20 P2 X1 Y1 Z1"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set to G55",
        "send":["G55"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Read G55 offsets",
        "send":["{G55:n}"]},
    "r":{"g55":{"x":49,"y":49,"z":-31,"a":0,"b":0,"c":0}, "status":0}
}
#
{
    "t":{"label":"Report starting position in G55 coordinates",
        "before":["G55"],
        "send":["{sr:n}"]},
    "r":{"status":0, "sr":{"posx":1.0,"posy":1.0,"posz":1.0}}
}
# Run G28 / G55 test
{
    "t":{"label":"Move to new position in G55",
        "before":["G55"],
        "send":["g0 x20 y20 z-10"]},
    "r":{"status":0},
    "sr":{"posx": 20, "posy": 20, "posz": -10}
}
#
{
    "t":{"label":"Return to G28 starting position",
        "before":["G55"],
        "send":["G28"]},
    "r":{"status":0},
    "sr":{"posx": 1, "posy": 1, "posz": 1}
}
# EOF
# G28 / G55 INCHES TEST
#
{
    "t":{"label":"Move to new position in G55 INCHES mode",
        "before":["G55","G20"],
        "send":["g0 x2 y1.5 z-0.5"]},
    "r":{"status":0},
    "sr":{"posx": 2, "posy": 1.5, "posz": -0.5}
}
#
{
    "t":{"label":"Return to G28 starting position while in G20 INCHES mode ",
        "before":["G55","G20"],
        "send":["G28"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}

# EOF

#
# G28 / G55 TEST SETUP
#
{
    "t":{"label":"Save current position as G28 starting position in G54",
        "send":["G54","G28.1"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set G55 coordinates (0,0,0)",
        "send":["G10 L20 P2 X0 Y0 Z0"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set to G55",
        "send":["G55"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Report starting position in G55 coordinates",
        "before":["G55"],
        "send":["{sr:n}"]},
    "r":{"status":0, "sr":{"posx":0.0,"posy":0.0,"posz":0.0}}
}
#
# G28 / G55 TEST
#
{
    "t":{"label":"Move to new position in G55",
        "before":["G55"],
        "send":["g0 x20 y20 z-10"]},
    "r":{"status":0},
    "sr":{"posx": 20, "posy": 20, "posz": -10}
}
#
{
    "t":{"label":"Return to G28 starting position",
        "before":["G55"],
        "send":["G28"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}
# EOF





#
# G28 / G55 TEST SETUP
#
{
    "t":{"label":"Save current position as G28 starting position in G54",
        "send":["G54","G28.1"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set G55 coordinates (0,0,0)",
        "send":["G10 L20 P2 X0 Y0 Z0"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Set to G55",
        "send":["G55"]},
    "r":{"status":0}
}
#
{
    "t":{"label":"Report starting position in G55 coordinates",
        "before":["G55"],
        "send":["{sr:n}"]},
    "r":{"status":0, "sr":{"posx":0.0,"posy":0.0,"posz":0.0}}
}
#
# G28 / G55 TEST
#
{
    "t":{"label":"Move to new position in G55",
        "before":["G55"],
        "send":["g0 x20 y20 z-10"]},
    "r":{"status":0},
    "sr":{"posx": 20, "posy": 20, "posz": -10}
}
#
{
    "t":{"label":"Return to G28 starting position",
        "before":["G55"],
        "send":["G28"]},
    "r":{"status":0},
    "sr":{"posx": 0, "posy": 0, "posz": 0}
}
# EOF
